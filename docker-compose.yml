version: '3'

services:

  postgres:
    container_name: postgres
    restart: always
    image: postgres:12.2-alpine
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASS}
      - POSTGRES_DB=${DB_NAME}
    volumes:
      - thetrains-db:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  collector:
    container_name: collector
    restart: always
    build: ./collector
    depends_on:
      - postgres
    environment:
      - NR_USER=${NR_USER}
      - NR_PASS=${NR_PASS}
      - PYTHONUNBUFFERED=0
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - DB_NAME=${DB_NAME}
    command: -t RTPPM

  dash:
    container_name: dash
    restart: always
    build: ./dash
    ports:
      - "8000:8000"
    depends_on:
      - postgres
    environment:
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - DB_NAME=${DB_NAME}
      - MAPBOX_TOKEN=${MAPBOX_TOKEN}

  nginx:
    container_name: nginx
    restart: unless-stopped
    build: ./nginx
    ports:
        - 80:80/tcp
        - 443:443/tcp
    environment:
        CERTBOT_EMAIL: ${NR_USER}
    volumes:
      - letsencrypt:/etc/letsencrypt
    depends_on:
      - dash

volumes:
  thetrains-db:
  letsencrypt:
